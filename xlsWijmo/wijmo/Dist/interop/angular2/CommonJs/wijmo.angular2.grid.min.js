/*
    *
    * Wijmo Library 5.20162.188
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the Wijmo Commercial License.
    * sales@wijmo.com
    * http://wijmo.com/products/wijmo-5/license/
    *
    */
"use strict";
var __extends=this && this.__extends || function(d, b)
{
function __()
{
this.constructor = d
}
for (var p in b)
b.hasOwnProperty(p) && (d[p] = b[p]);
d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __)
},
__decorate=this && this.__decorate || function(decorators, target, key, desc)
{
var c=arguments.length,
r=c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
d,
i;
if (typeof Reflect == "object" && typeof Reflect.decorate == "function")
r = Reflect.decorate(decorators, target, key, desc);
else
for (i = decorators.length - 1; i >= 0; i--)
(d = decorators[i]) && (r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r);
return c > 3 && r && Object.defineProperty(target, key, r), r
},
__param=this && this.__param || function(paramIndex, decorator)
{
return function(target, key)
{
decorator(target, key, paramIndex)
}
},
core_1=require('@angular/core'),
core_2=require('@angular/core'),
wijmo_angular2_directiveBase_1=require('wijmo/wijmo.angular2.directiveBase'),
WjFlexGrid=function(_super)
{
function WjFlexGrid(elRef, injector)
{
var _this=this;
_super.call(this, wijmo_angular2_directiveBase_1.WjDirectiveBehavior.getHostElement(elRef));
new DirectiveCellFactory(this);
wijmo_angular2_directiveBase_1.WjDirectiveBehavior.attach(this, elRef, injector);
this.deferUpdate(function()
{
if (_this.rows.defaultSize < 10)
{
var e=_this.hostElement,
csh=getComputedStyle(e),
csb=getComputedStyle(document.body),
defRowHei=parseInt(csh.fontSize && wijmo.contains(document.body, e) ? csh.fontSize : csb.fontSize) * 2;
_this.rows.defaultSize = defRowHei;
_this.columns.defaultSize = defRowHei * 4;
_this.columnHeaders.rows.defaultSize = defRowHei;
_this.rowHeaders.columns.defaultSize = Math.round(defRowHei * 1.25)
}
})
}
return __extends(WjFlexGrid, _super), __decorate([wijmo_angular2_directiveBase_1.WjComponent({
selector: 'wj-flex-grid', template: "<div><ng-content></ng-content></div>"
}), __param(0, core_2.Inject(core_1.ElementRef)), __param(1, core_2.Inject(core_2.Injector))], WjFlexGrid)
}(wijmo.grid.FlexGrid),
WjFlexGridColumn,
CellTemplateType,
WjFlexGridCellTemplate,
DirectiveCellFactory;
exports.WjFlexGrid = WjFlexGrid;
WjFlexGridColumn = function(_super)
{
function WjFlexGridColumn(elRef, injector)
{
_super.call(this);
var behavior=wijmo_angular2_directiveBase_1.WjDirectiveBehavior.attach(this, elRef, injector),
gridCmp=behavior.parentBehavior.directive;
gridCmp.autoGenerateColumns && (gridCmp.autoGenerateColumns = !1, gridCmp.columns.clear())
}
return __extends(WjFlexGridColumn, _super), __decorate([wijmo_angular2_directiveBase_1.WjComponent({
selector: 'wj-flex-grid-column', wjParentDirectives: [WjFlexGrid], template: "<div><ng-content></ng-content></div>"
}), __param(0, core_2.Inject(core_1.ElementRef)), __param(1, core_2.Inject(core_2.Injector))], WjFlexGridColumn)
}(wijmo.grid.Column);
exports.WjFlexGridColumn = WjFlexGridColumn,
function(CellTemplateType)
{
CellTemplateType[CellTemplateType.Cell = 0] = "Cell";
CellTemplateType[CellTemplateType.CellEdit = 1] = "CellEdit";
CellTemplateType[CellTemplateType.ColumnHeader = 2] = "ColumnHeader";
CellTemplateType[CellTemplateType.RowHeader = 3] = "RowHeader";
CellTemplateType[CellTemplateType.RowHeaderEdit = 4] = "RowHeaderEdit";
CellTemplateType[CellTemplateType.TopLeft = 5] = "TopLeft";
CellTemplateType[CellTemplateType.GroupHeader = 6] = "GroupHeader";
CellTemplateType[CellTemplateType.Group = 7] = "Group";
CellTemplateType[CellTemplateType.NewCellTemplate = 8] = "NewCellTemplate"
}(exports.CellTemplateType || (exports.CellTemplateType = {}));
CellTemplateType = exports.CellTemplateType;
WjFlexGridCellTemplate = function()
{
function WjFlexGridCellTemplate(viewContainerRef, templateRef, elRef, domRenderer, injector)
{
this.viewContainerRef = viewContainerRef;
this.templateRef = templateRef;
this.elRef = elRef;
this.domRenderer = domRenderer;
var gridBehavior=wijmo_angular2_directiveBase_1.WjDirectiveBehavior.findParentBehavior(injector, [WjFlexGrid]),
columnBehavior=wijmo_angular2_directiveBase_1.WjDirectiveBehavior.findParentBehavior(injector, [WjFlexGridColumn], gridBehavior);
this.grid = gridBehavior.directive;
columnBehavior && (this.column = columnBehavior.directive)
}
return WjFlexGridCellTemplate._getTemplContextProp = function(templateType)
{
return '$__cellTempl' + CellTemplateType[templateType]
}, WjFlexGridCellTemplate.prototype.ngOnInit = function()
{
this.ownerControl = this.column && this.column.grid === this.grid ? this.column : this.grid;
this._attachToControl()
}, WjFlexGridCellTemplate.prototype.ngOnDestroy = function()
{
this.cellTypeStr && (this.viewContainerRef.clear(), this.ownerControl[WjFlexGridCellTemplate._getTemplContextProp(this.cellType)] = null, this.grid.invalidate())
}, WjFlexGridCellTemplate.prototype._instantiateTemplate = function(parent)
{
return wijmo_angular2_directiveBase_1.WjDirectiveBehavior.instantiateTemplate(parent, this.viewContainerRef, this.templateRef, this.domRenderer)
}, WjFlexGridCellTemplate.prototype._attachToControl = function()
{
this.cellTypeStr && (this.cellType = wijmo.asEnum(this.cellTypeStr, CellTemplateType), this.ownerControl[WjFlexGridCellTemplate._getTemplContextProp(this.cellType)] = this, this.grid.invalidate())
}, WjFlexGridCellTemplate = __decorate([core_1.Directive({
selector: '[wjFlexGridCellTemplate]', inputs: ['wjFlexGridCellTemplate', 'cellTypeStr: cellType', 'cellOverflow', 'valuePaths']
}), __param(0, core_2.Inject(core_1.ViewContainerRef)), __param(1, core_2.Inject(core_1.TemplateRef)), __param(1, core_2.Optional()), __param(2, core_2.Inject(core_1.ElementRef)), __param(3, core_2.Inject(core_2.Renderer)), __param(4, core_2.Inject(core_2.Injector))], WjFlexGridCellTemplate)
}();
exports.WjFlexGridCellTemplate = WjFlexGridCellTemplate;
DirectiveCellFactory = function(_super)
{
function DirectiveCellFactory(grid)
{
var templateType,
self;
if (_super.call(this), this._lastApplyTimeStamp = 0, this._noApplyLag = !1, this._startingEditing = !1, this._cellStampCounter = 0, this.grid = grid, !DirectiveCellFactory._templateTypes)
{
DirectiveCellFactory._templateTypes = [];
for (templateType in CellTemplateType)
isNaN(templateType) && DirectiveCellFactory._templateTypes.push(templateType)
}
self = this;
this._baseCf = grid.cellFactory;
grid.cellFactory = this;
this._evtInput = document.createEvent('HTMLEvents');
this._evtInput.initEvent('input', !0, !1);
this._evtBlur = document.createEvent('HTMLEvents');
this._evtBlur.initEvent('blur', !1, !1);
grid.prepareCellForEdit.addHandler(function()
{
self._noApplyLag = !0
});
grid.cellEditEnded.addHandler(function(s, e)
{
(e.range.col < 0 || e.range.col < grid.columns.length && !grid.columns[e.range.col][WjFlexGridCellTemplate._getTemplContextProp(CellTemplateType.CellEdit)]) && (self._editChar = null);
setTimeout(function()
{
self._noApplyLag = !1
}, 300)
});
grid.beginningEdit.addHandler(function()
{
self._startingEditing = !0
});
grid.hostElement.addEventListener('keydown', function()
{
self._startingEditing = !1
}, !0);
grid.hostElement.addEventListener('keypress', function(e)
{
var char=e.charCode > 32 ? String.fromCharCode(e.charCode) : null;
char && (!grid.activeEditor || self._startingEditing ? self._editChar = char : self._editChar && (self._editChar += char))
}, !0)
}
return __extends(DirectiveCellFactory, _super), DirectiveCellFactory.prototype.updateCell = function(panel, rowIndex, colIndex, cell, rng)
{
var cellStamp,
isHierNonGroup,
isUpdated,
col,
templContextProp,
templContext,
isTpl,
cellValue,
cellContext,
isForeignCell,
rootEl,
templInstance,
cellInfo_1,
editEndingEH;
this._cellStampCounter = (this._cellStampCounter + 1) % 1e7;
cellStamp = cell[DirectiveCellFactory._cellStampProp] = this._cellStampCounter;
cell.style.overflow && (cell.style.overflow = '');
var self=this,
grid=panel.grid,
editRange=grid.editRange,
templateType,
row=panel.rows[rowIndex],
dataItem=row.dataItem,
isGridCtx=!1,
needCellValue=!1,
isEdit=!1,
isCvGroup=!1;
switch (panel.cellType)
{
case wijmo.grid.CellType.Cell:
row instanceof wijmo.grid.GroupRow ? (isCvGroup = dataItem instanceof wijmo.collections.CollectionViewGroup, isHierNonGroup = !(isCvGroup || row.hasChildren), colIndex == panel.columns.firstVisibleIndex ? templateType = isHierNonGroup ? CellTemplateType.Cell : CellTemplateType.GroupHeader : (templateType = isHierNonGroup ? CellTemplateType.Cell : CellTemplateType.Group, needCellValue = !0)) : row instanceof wijmo.grid._NewRowTemplate ? templateType = CellTemplateType.NewCellTemplate : editRange && editRange.row === rowIndex && editRange.col === colIndex ? (templateType = CellTemplateType.CellEdit, needCellValue = isEdit = !0) : wijmo.grid.detail && wijmo.grid.detail.DetailRow && row instanceof wijmo.grid.detail.DetailRow || (templateType = CellTemplateType.Cell);
break;
case wijmo.grid.CellType.ColumnHeader:
templateType = CellTemplateType.ColumnHeader;
break;
case wijmo.grid.CellType.RowHeader:
templateType = grid.collectionView && grid.collectionView.currentEditItem === dataItem ? CellTemplateType.RowHeaderEdit : CellTemplateType.RowHeader;
isGridCtx = !0;
break;
case wijmo.grid.CellType.TopLeft:
templateType = CellTemplateType.TopLeft;
isGridCtx = !0
}
isUpdated = !1;
templateType != null && (col = isCvGroup && templateType == CellTemplateType.GroupHeader ? grid.columns.getColumn(dataItem.groupDescription.propertyName) : colIndex >= 0 && colIndex < panel.columns.length ? panel.columns[colIndex] : null, col && (templContextProp = WjFlexGridCellTemplate._getTemplContextProp(templateType), templContext = (isGridCtx ? grid : col)[templContextProp], templContext || (templateType === CellTemplateType.RowHeaderEdit ? (templateType = CellTemplateType.RowHeader, templContextProp = WjFlexGridCellTemplate._getTemplContextProp(templateType), templContext = grid[templContextProp]) : (templateType === CellTemplateType.Group || templateType === CellTemplateType.GroupHeader) && (isCvGroup || (templateType = CellTemplateType.Cell, templContextProp = WjFlexGridCellTemplate._getTemplContextProp(templateType), templContext = col[templContextProp]))), templContext && (isTpl = !0, needCellValue && (cellValue = panel.getCellData(rowIndex, colIndex, !1)), isTpl && (isUpdated = !0, isEdit && this._baseCf.updateCell(panel, rowIndex, colIndex, cell, rng, !0), cellContext = cell[templContextProp] || {}, isForeignCell = cellContext.column !== col || !cellContext.viewRef || cellContext.templateContextProperty !== templContextProp || cell.firstChild != cellContext.rootElement, isForeignCell && (isEdit ? (rootEl = cell.firstElementChild, rootEl && (cell.focus(), rootEl.style.display = 'none')) : cell.textContent = '', this._doDisposeCell(cell), templInstance = templContext._instantiateTemplate(cell), cellContext.column = col, cellContext.viewRef = templInstance.viewRef, cellContext.rootElement = templInstance.rootElement, cellContext.templateContextProperty = templContextProp, cell[templContextProp] = cellContext), cellInfo_1 = this._setViewRefVars(cellContext.viewRef, row, col, dataItem, cellValue, templContext.valuePaths), templContext.cellOverflow && (cell.style.overflow = templContext.cellOverflow), setTimeout(function()
{
var inputs,
i,
input,
inpSt,
inpFocusEh;
if (cellStamp === cell[DirectiveCellFactory._cellStampProp])
{
var cellHeight=cell.scrollHeight,
panelRows=panel.rows,
rowSpan=rng && rng.rowSpan || 1;
if (rowIndex < panelRows.length && panelRows[rowIndex].renderHeight * rowSpan < cellHeight - 1)
{
if (panelRows.defaultSize = cellHeight / rowSpan, isEdit)
{
grid.refresh();
grid.startEditing();
return
}
}
else if (isEdit && !wijmo.contains(cellContext.rootElement, wijmo.getActiveElement()) && (inputs = cellContext && cellContext.rootElement && cellContext.rootElement.querySelectorAll('input'), inputs))
for (i = 0; i < inputs.length; i++)
if (input = inputs[i], inpSt = window.getComputedStyle(input), inpSt.display !== 'none' && inpSt.visibility === 'visible')
{
inpFocusEh = function()
{
input.removeEventListener('focus', inpFocusEh);
setTimeout(function()
{
self._editChar && (input.value = self._editChar, self._editChar = null, wijmo.setSelectionRange(input, input.value.length), input.dispatchEvent(self._evtInput))
}, 0)
};
input.addEventListener('focus', inpFocusEh);
input.focus();
break
}
}
}, 0), isEdit ? (editEndingEH = function(s, e)
{
var activeElement,
_i,
bindNames_1,
curName,
dropDowns;
if (grid.cellEditEnding.removeHandler(editEndingEH), activeElement = wijmo.getActiveElement(), activeElement && activeElement.dispatchEvent(self._evtBlur), cell.focus(), !e.cancel)
{
e.cancel = !0;
var cellVar=cellInfo_1.localVars,
newVal=cellVar.value,
bindNames=Object.getOwnPropertyNames(cellInfo_1.bindings);
for (panel.grid.setCellData(rowIndex, colIndex, newVal), _i = 0, bindNames_1 = bindNames; _i < bindNames_1.length; _i++)
curName = bindNames_1[_i],
cellInfo_1.bindings[curName].setValue(cellVar, cellInfo_1.localVars.values[curName])
}
dropDowns = cell.querySelectorAll('.wj-dropdown');
[].forEach.call(dropDowns, function(el)
{
var ctrl=wijmo.Control.getControl(el);
ctrl && ctrl instanceof wijmo.input.DropDown && (ctrl.isDroppedDown = !1)
})
}, grid.cellEditEnding.addHandler(editEndingEH)) : this._baseCf.updateCell(panel, rowIndex, colIndex, cell, rng, !1)))));
isUpdated || (this._doDisposeCell(cell), this._baseCf.updateCell(panel, rowIndex, colIndex, cell, rng))
}, DirectiveCellFactory.prototype.disposeCell = function(cell)
{
this._doDisposeCell(cell)
}, DirectiveCellFactory.prototype._doDisposeCell = function(cell)
{
for (var templContextProp, cellContext, templateOwner, templateContext, viewIdx, ttm=DirectiveCellFactory._templateTypes, i=0; i < ttm.length; i++)
templContextProp = WjFlexGridCellTemplate._getTemplContextProp(CellTemplateType[ttm[i]]),
cellContext = cell[templContextProp],
cellContext && cellContext.viewRef && (templateOwner = cellContext.column || this.grid, templateContext = templateOwner[templContextProp], templateContext && (viewIdx = templateContext.viewContainerRef.indexOf(cellContext.viewRef), viewIdx > -1 && templateContext.viewContainerRef.remove(viewIdx)), cellContext.viewRef = null, cellContext.rootElement = null, cellContext.column = null, cellContext.templateContextProperty = null, cell[templContextProp] = null)
}, DirectiveCellFactory.prototype._setViewRefVars = function(viewRef, row, col, dataItem, cellValue, valuePaths)
{
var pathNames,
_i,
pathNames_1,
pName,
binding;
viewRef.context.row = row;
viewRef.context.col = col;
viewRef.context.item = dataItem;
var values={},
cellCtx={
row: row, col: col, item: dataItem, value: cellValue, values: values
},
bindings={},
ret={
localVars: cellCtx, bindings: bindings
};
if (valuePaths)
for (pathNames = Object.getOwnPropertyNames(valuePaths), _i = 0, pathNames_1 = pathNames; _i < pathNames_1.length; _i++)
pName = pathNames_1[_i],
binding = new wijmo.Binding(valuePaths[pName]),
bindings[pName] = binding,
values[pName] = binding.getValue(cellCtx);
return viewRef.context.cell = cellCtx, ret
}, DirectiveCellFactory._cellStampProp = '__wjCellStamp', DirectiveCellFactory
}(wijmo.grid.CellFactory)